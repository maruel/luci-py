FROM gcr.io/chrome-infra-spinnaker/infra as builder

RUN  gclient sync && cd /infra && \
     git checkout master && git pull --recurse-submodules
RUN  mkdir -p /infra_shallow/infra && cd /infra_shallow && \
     git clone --depth=1 file:////infra ./infra && \
     rm -rf /infra && \
     mv /infra_shallow/* /


FROM gcr.io/chrome-infra-spinnaker/infra
COPY --from=builder /infra /infra
RUN  cd /infra/luci && git checkout master && \
     rm -rf appengine/config_service/*
ADD  luci-config.tar /infra/luci/appengine/config_service
RUN  cd /infra/luci/appengine/config_service && \
     make external_deps
RUN  mkdir /workspace
ENV  TARDIR /workspace
RUN  rm /infra/luci/appengine/config_service/tools/protoc
WORKDIR /infra/luci/appengine/config_service
CMD  ["make", "package"]
