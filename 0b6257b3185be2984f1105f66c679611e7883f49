{
  "comments": [
    {
      "key": {
        "uuid": "f997bbc3_91d8f7b9",
        "filename": "appengine/isolate/handlers_endpoints_v1.py",
        "patchSetId": 7
      },
      "lineNbr": 60,
      "author": {
        "id": 1161379
      },
      "writtenOn": "2020-03-24T06:19:46Z",
      "side": 1,
      "message": "I still have bit concern about PII handling when get_current_identity().is_user case.\n\nSo how do you think only loging that identity is come from user if is_user \u003d\u003d True and check whether there are still many access from user account after migrating known python client usage?",
      "range": {
        "startLine": 60,
        "startChar": 41,
        "endLine": 60,
        "endChar": 68
      },
      "revId": "0b6257b3185be2984f1105f66c679611e7883f49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "606aae5d_276a66e8",
        "filename": "appengine/isolate/handlers_endpoints_v1.py",
        "patchSetId": 7
      },
      "lineNbr": 60,
      "author": {
        "id": 1375000
      },
      "writtenOn": "2020-03-24T06:34:05Z",
      "side": 1,
      "message": "\u003e So how do you think only loging that identity is come from user if is_user \u003d\u003d True\n\nSGTM\n\n\u003e and check whether there are still many access from user account after migrating known python client usage?\n\nI think we are already in this stage?\n\nFYI the policy for PII in prod remote debug log: https://g3doc.corp.google.com/monitoring/logging/g3doc/remote_debug_logging/user_data.md#pii. It doesn\u0027t forbid PII at least. Do we know that only people with the proper ACL can access these logs?",
      "parentUuid": "f997bbc3_91d8f7b9",
      "range": {
        "startLine": 60,
        "startChar": 41,
        "endLine": 60,
        "endChar": 68
      },
      "revId": "0b6257b3185be2984f1105f66c679611e7883f49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e44dc182_86a0ac36",
        "filename": "appengine/isolate/handlers_endpoints_v1.py",
        "patchSetId": 7
      },
      "lineNbr": 60,
      "author": {
        "id": 1161379
      },
      "writtenOn": "2020-03-24T06:41:21Z",
      "side": 1,
      "message": "\u003e \u003e and check whether there are still many access from user account after migrating known python client usage?\n\u003e \n\u003e I think we are already in this stage?\n\nAh, I see.\n\n\u003e \n\u003e FYI the policy for PII in prod remote debug log: https://g3doc.corp.google.com/monitoring/logging/g3doc/remote_debug_logging/user_data.md#pii. It doesn\u0027t forbid PII at least. Do we know that only people with the proper ACL can access these logs?\n\nI currently think swarming projects allow broader access more than necessary, so still want to defer or avoid user id logging.",
      "parentUuid": "606aae5d_276a66e8",
      "range": {
        "startLine": 60,
        "startChar": 41,
        "endLine": 60,
        "endChar": 68
      },
      "revId": "0b6257b3185be2984f1105f66c679611e7883f49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "65589ca2_832501bd",
        "filename": "appengine/isolate/handlers_endpoints_v1.py",
        "patchSetId": 7
      },
      "lineNbr": 60,
      "author": {
        "id": 1375000
      },
      "writtenOn": "2020-03-24T06:47:45Z",
      "side": 1,
      "message": "i thought we first agreed on logging user id? what else would be a good replacement here?",
      "parentUuid": "e44dc182_86a0ac36",
      "range": {
        "startLine": 60,
        "startChar": 41,
        "endLine": 60,
        "endChar": 68
      },
      "revId": "0b6257b3185be2984f1105f66c679611e7883f49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "a73210ed_cf0b0859",
        "filename": "appengine/isolate/handlers_endpoints_v1.py",
        "patchSetId": 7
      },
      "lineNbr": 60,
      "author": {
        "id": 1161379
      },
      "writtenOn": "2020-03-24T08:47:26Z",
      "side": 1,
      "message": "Sorry, but I changed my mind.\n\nMy concern is that whether we have sufficiently narrowed permission for log.\nhttps://pantheon.corp.google.com/iam-admin/iam?project\u003disolateserver\nAnd I think http://shortn/_g9nTkYhDhz currently has bit too many people.\n\nAlso we rather want to knonw which service accounts are using python client. So I\u0027d like to let user contact us by themselfs if we lost compatibility to python client after announncement instead of logging and contact to user from ourselfs.",
      "parentUuid": "65589ca2_832501bd",
      "range": {
        "startLine": 60,
        "startChar": 41,
        "endLine": 60,
        "endChar": 68
      },
      "revId": "0b6257b3185be2984f1105f66c679611e7883f49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "1964779f_187616a4",
        "filename": "appengine/isolate/handlers_endpoints_v1.py",
        "patchSetId": 7
      },
      "lineNbr": 60,
      "author": {
        "id": 1375000
      },
      "writtenOn": "2020-03-24T08:58:56Z",
      "side": 1,
      "message": "Then do you think this CL is still necessary? Sounds like we should just remove the client and. wait for users to contact us (maybe send out PSA in luci-announce first)?\n\nIMO if all the python client users are internal Googlers, it should be fine. PII applies more to the external (actual) users? WDYT?",
      "parentUuid": "a73210ed_cf0b0859",
      "range": {
        "startLine": 60,
        "startChar": 41,
        "endLine": 60,
        "endChar": 68
      },
      "revId": "0b6257b3185be2984f1105f66c679611e7883f49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ffecf291_984b787c",
        "filename": "appengine/isolate/handlers_endpoints_v1.py",
        "patchSetId": 7
      },
      "lineNbr": 60,
      "author": {
        "id": 1161379
      },
      "writtenOn": "2020-03-24T09:11:30Z",
      "side": 1,
      "message": "\u003e Then do you think this CL is still necessary? Sounds like we should just remove the client and. wait for users to contact us (maybe send out PSA in luci-announce first)?\n\u003e \n\nYes, I think this is still necessary. I guess currently most of access are come from python client run in swarming bot code, but after we migrated that to go client, this will help to identify python client usage from some service account.\nhttps://screenshot.googleplex.com/k0NhtidbuFZ\n\nnote that we have 5 isolate server instances and we even don\u0027t know the code location accessing some of those instances.\nhttps://chrome-internal.googlesource.com/infra/infra_internal/+/master/appengine/deploy.json#46\n\n\u003e IMO if all the python client users are internal Googlers, it should be fine. PII applies more to the external (actual) users? WDYT?\n\nCurrently read access is allowed to everyone (\u0027*\u0027), so it may accidentally log non-internal user.\nhttps://chrome-infra-auth.appspot.com/auth/groups/isolateserver-readonly-access",
      "parentUuid": "1964779f_187616a4",
      "range": {
        "startLine": 60,
        "startChar": 41,
        "endLine": 60,
        "endChar": 68
      },
      "revId": "0b6257b3185be2984f1105f66c679611e7883f49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "2c8ec80c_d26d8a2b",
        "filename": "appengine/isolate/handlers_endpoints_v1.py",
        "patchSetId": 7
      },
      "lineNbr": 60,
      "author": {
        "id": 1375000
      },
      "writtenOn": "2020-03-24T10:04:47Z",
      "side": 1,
      "message": "\u003e  Yes, I think this is still necessary. I guess currently most of access are come from python client run in swarming bot code, but after we migrated that to go client, this will help to identify python client usage from some service account.\n\nSorry i still don\u0027t get it. If this is necessary, then we should log something at least? Do you prefer logging the service account?\n\n\u003e Currently read access is allowed to everyone (\u0027*\u0027), so it may accidentally log non-internal user.\n\nAre external users supposed  to use isolateserver at  all? If not, we shouldn\u0027t worry about breaking their usage. What about log when is_user\u003d\u003dTrue \u0026\u0026 endsqwith(\u0027@google.com\u0027)?",
      "parentUuid": "ffecf291_984b787c",
      "range": {
        "startLine": 60,
        "startChar": 41,
        "endLine": 60,
        "endChar": 68
      },
      "revId": "0b6257b3185be2984f1105f66c679611e7883f49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "040e4fe1_879038ea",
        "filename": "appengine/isolate/handlers_endpoints_v1.py",
        "patchSetId": 7
      },
      "lineNbr": 60,
      "author": {
        "id": 1161379
      },
      "writtenOn": "2020-03-24T10:31:00Z",
      "side": 1,
      "message": "\u003e \u003e  Yes, I think this is still necessary. I guess currently most of access are come from python client run in swarming bot code, but after we migrated that to go client, this will help to identify python client usage from some service account.\n\u003e \n\u003e Sorry i still don\u0027t get it. If this is necessary, then we should log something at least? Do you prefer logging the service account?\n\nAh, sorry. I thought is_user \u003d\u003d False for service account.\nBut seems not.\nhttps://cs.chromium.org/chromium/infra/luci/appengine/components/components/auth/model.py?l\u003d132\u0026rcl\u003dce889b27715ca372ad454c8dc6f9c86fb2979755\n\nSo my preference is show user account only when it has \u0027.gserviceaccount.com\u0027 as suffix.\n\n\u003e \n\u003e \u003e Currently read access is allowed to everyone (\u0027*\u0027), so it may accidentally log non-internal user.\n\u003e \n\u003e Are external users supposed  to use isolateserver at  all? If not, we shouldn\u0027t worry about breaking their usage. What about log when is_user\u003d\u003dTrue \u0026\u0026 endsqwith(\u0027@google.com\u0027)?\n\nI think we somewhat support access from external contributor. I don\u0027t expect there are many though.\nBut as long as we updated existing documents, I still would like to avoid logging human account currently.",
      "parentUuid": "2c8ec80c_d26d8a2b",
      "range": {
        "startLine": 60,
        "startChar": 41,
        "endLine": 60,
        "endChar": 68
      },
      "revId": "0b6257b3185be2984f1105f66c679611e7883f49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "0024a834_9898daf7",
        "filename": "appengine/isolate/handlers_endpoints_v1.py",
        "patchSetId": 7
      },
      "lineNbr": 60,
      "author": {
        "id": 1375000
      },
      "writtenOn": "2020-03-24T10:35:46Z",
      "side": 1,
      "message": "Ah ok, logging service account sounds a lot safer..  (will make the change tmr)",
      "parentUuid": "040e4fe1_879038ea",
      "range": {
        "startLine": 60,
        "startChar": 41,
        "endLine": 60,
        "endChar": 68
      },
      "revId": "0b6257b3185be2984f1105f66c679611e7883f49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ada9bb05_e10fce26",
        "filename": "appengine/isolate/handlers_endpoints_v1.py",
        "patchSetId": 7
      },
      "lineNbr": 60,
      "author": {
        "id": 1375000
      },
      "writtenOn": "2020-03-25T03:19:31Z",
      "side": 1,
      "message": "Done. Logging only when is_user\u003d\u003dTrue \u0026\u0026 endswith(\u0027.gserviceaccount.com\u0027)",
      "parentUuid": "0024a834_9898daf7",
      "range": {
        "startLine": 60,
        "startChar": 41,
        "endLine": 60,
        "endChar": 68
      },
      "revId": "0b6257b3185be2984f1105f66c679611e7883f49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "b6369b13_9dc06129",
        "filename": "appengine/isolate/handlers_endpoints_v1.py",
        "patchSetId": 7
      },
      "lineNbr": 60,
      "author": {
        "id": 1375000
      },
      "writtenOn": "2020-03-25T04:40:50Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "ada9bb05_e10fce26",
      "range": {
        "startLine": 60,
        "startChar": 41,
        "endLine": 60,
        "endChar": 68
      },
      "revId": "0b6257b3185be2984f1105f66c679611e7883f49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "d9383b95_057cbb4f",
        "filename": "appengine/isolate/handlers_endpoints_v1.py",
        "patchSetId": 7
      },
      "lineNbr": 590,
      "author": {
        "id": 1161379
      },
      "writtenOn": "2020-03-24T06:19:46Z",
      "side": 1,
      "message": "why not write this inline?",
      "revId": "0b6257b3185be2984f1105f66c679611e7883f49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "1fdcdc0d_f86d9e1f",
        "filename": "appengine/isolate/handlers_endpoints_v1.py",
        "patchSetId": 7
      },
      "lineNbr": 590,
      "author": {
        "id": 1375000
      },
      "writtenOn": "2020-03-24T06:34:05Z",
      "side": 1,
      "message": "mostly for mocking",
      "parentUuid": "d9383b95_057cbb4f",
      "revId": "0b6257b3185be2984f1105f66c679611e7883f49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "f8b946a6_190bd9ce",
        "filename": "appengine/isolate/handlers_endpoints_v1.py",
        "patchSetId": 7
      },
      "lineNbr": 590,
      "author": {
        "id": 1161379
      },
      "writtenOn": "2020-03-24T06:41:21Z",
      "side": 1,
      "message": "You can use mock\nhttps://pypi.org/project/mock/",
      "parentUuid": "1fdcdc0d_f86d9e1f",
      "revId": "0b6257b3185be2984f1105f66c679611e7883f49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "eea7333f_6fdbf6e5",
        "filename": "appengine/isolate/handlers_endpoints_v1.py",
        "patchSetId": 7
      },
      "lineNbr": 590,
      "author": {
        "id": 1375000
      },
      "writtenOn": "2020-03-24T06:47:45Z",
      "side": 1,
      "message": "i mean i need this function in order to do the mocking. or am i miss understanding what you meant by \"inline\"?",
      "parentUuid": "f8b946a6_190bd9ce",
      "revId": "0b6257b3185be2984f1105f66c679611e7883f49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "7c12f190_f23169c6",
        "filename": "appengine/isolate/handlers_endpoints_v1.py",
        "patchSetId": 7
      },
      "lineNbr": 590,
      "author": {
        "id": 1161379
      },
      "writtenOn": "2020-03-24T08:47:26Z",
      "side": 1,
      "message": "I think you can check the behavior by using mock.assert_any_call(...) and with @patch(\u0027logging.info\u0027)?\nhttps://docs.python.org/dev/library/unittest.mock.html#unittest.mock.patch\nhttps://docs.python.org/dev/library/unittest.mock.html#unittest.mock.Mock.assert_any_call\nand",
      "parentUuid": "eea7333f_6fdbf6e5",
      "revId": "0b6257b3185be2984f1105f66c679611e7883f49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "bb38f565_51bbb159",
        "filename": "appengine/isolate/handlers_endpoints_v1.py",
        "patchSetId": 7
      },
      "lineNbr": 590,
      "author": {
        "id": 1375000
      },
      "writtenOn": "2020-03-24T08:58:56Z",
      "side": 1,
      "message": "Thanks for the materials, but I\u0027d prefer to test what rather than how... go/tott/571 Anyway, i feel like this pattern of having a _impl for mocking a bit more common in this codebase?",
      "parentUuid": "7c12f190_f23169c6",
      "revId": "0b6257b3185be2984f1105f66c679611e7883f49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c05faa96_ba6a999c",
        "filename": "appengine/isolate/handlers_endpoints_v1.py",
        "patchSetId": 7
      },
      "lineNbr": 590,
      "author": {
        "id": 1161379
      },
      "writtenOn": "2020-03-25T04:05:31Z",
      "side": 1,
      "message": "\u003e Thanks for the materials, but I\u0027d prefer to test what rather than how... go/tott/571\n\nI think using mock can test what too?\n\n\u003e Anyway, i feel like this pattern of having a _impl for mocking a bit more common in this codebase?\n\nI think that is due to lack of standardization due to difficulty of using non-standard library or non-existence of mock in the past.\nBut we can now use mock, this is actually not standard, but I think this is kind of standard and want to use that than following existing practice here.",
      "parentUuid": "bb38f565_51bbb159",
      "revId": "0b6257b3185be2984f1105f66c679611e7883f49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "7e7215f2_bbe5e9f7",
        "filename": "appengine/isolate/handlers_endpoints_v1.py",
        "patchSetId": 7
      },
      "lineNbr": 590,
      "author": {
        "id": 1375000
      },
      "writtenOn": "2020-03-25T04:40:50Z",
      "side": 1,
      "message": "1. the mock and unittest.mock are two different modules?\n2. they are only available in py3? what\u0027s the env to run this test? do i need to manually `pip install mock`?\n3. the very point you made to change to logging.warn would have already broke the test.\n4. is this bit worth so much discussion? i believe the main point of testing here is to verify if the decorator works as expected?",
      "parentUuid": "c05faa96_ba6a999c",
      "revId": "0b6257b3185be2984f1105f66c679611e7883f49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "fa5332be_b78bc246",
        "filename": "appengine/isolate/handlers_endpoints_v1.py",
        "patchSetId": 7
      },
      "lineNbr": 590,
      "author": {
        "id": 1161379
      },
      "writtenOn": "2020-03-25T05:16:28Z",
      "side": 1,
      "message": "\u003e 1. the mock and unittest.mock are two different modules?\n\nWe currently need to use https://pypi.org/project/mock/ which are backport of mock in python3.\n\nBut `import mock` works both in python2 and python3 if we use vpython.\nhttps://cs.chromium.org/search/?q\u003d%5Eimport%5C+mock$+file:%5Einfra/luci/appengine/+package:%5Echromium$\u0026type\u003dcs\n\n\u003e 2. they are only available in py3? what\u0027s the env to run this test? do i need to manually `pip install mock`?\n\nbackported mock in python2 is available as vpython module written in\nhttps://cs.chromium.org/chromium/infra/luci/.vpython?l\u003d22\u0026rcl\u003dce889b27715ca372ad454c8dc6f9c86fb2979755\nas long as we use vpython.\nYou don\u0027t need to use pip.\n\n\u003e 3. the very point you made to change to logging.warn would have already broke the test.\n\nI want to take care how the logging api is called. And it seems more explicit check than having this function for mocking in our own way?\n\n\u003e 4. is this bit worth so much discussion? i believe the main point of testing here is to verify if the decorator works as expected?\n\nHmm, maybe I\u0027m stubborn or too conservative here.\n\nI\u0027m doubting having this kind of function for our own way of mock follows the right (or standardrized) way and it is better than using mock library.",
      "parentUuid": "7e7215f2_bbe5e9f7",
      "revId": "0b6257b3185be2984f1105f66c679611e7883f49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "8b08d6ca_84fe87e0",
        "filename": "appengine/isolate/handlers_endpoints_v1.py",
        "patchSetId": 7
      },
      "lineNbr": 590,
      "author": {
        "id": 1375000
      },
      "writtenOn": "2020-03-25T05:56:30Z",
      "side": 1,
      "message": "Ok, then it sounds like we should use the https://pypi.org/project/mock/, since unittest.mock is only available for PY3? I\u0027m asking because this is a GAE app, and i thought it only supports PY2 (although this is just test, so maybe it doesn\u0027t matter.) \n\nAgain, is it the best way for me to manually install it? Or is there a command i should run which imports all the necessary modules..?",
      "parentUuid": "fa5332be_b78bc246",
      "revId": "0b6257b3185be2984f1105f66c679611e7883f49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "eb0285fc_7895a8d0",
        "filename": "appengine/isolate/handlers_endpoints_v1.py",
        "patchSetId": 7
      },
      "lineNbr": 590,
      "author": {
        "id": 1161379
      },
      "writtenOn": "2020-03-25T06:59:48Z",
      "side": 1,
      "message": "\u003e Ok, then it sounds like we should use the https://pypi.org/project/mock/, since unittest.mock is only available for PY3? I\u0027m asking because this is a GAE app, and i thought it only supports PY2 (although this is just test, so maybe it doesn\u0027t matter.) \n\u003e \n\nCorrect for the test of this change.\n\n\u003e Again, is it the best way for me to manually install it? Or is there a command i should run which imports all the necessary modules..?\n\nYou don\u0027t need to install by yourself.\nif you run the test like\n$ vpython appengine/isolate/handlers_endpoints_v1_test.py\nvpython automatically takes the mock library from CIPD.\n\nref: go/vpython-and-you",
      "parentUuid": "8b08d6ca_84fe87e0",
      "revId": "0b6257b3185be2984f1105f66c679611e7883f49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "0dc6cbfb_0e62d4ca",
        "filename": "appengine/isolate/handlers_endpoints_v1_test.py",
        "patchSetId": 7
      },
      "lineNbr": 606,
      "author": {
        "id": 1161379
      },
      "writtenOn": "2020-03-24T08:47:26Z",
      "side": 1,
      "message": "2 empty lines are sufficient.",
      "revId": "0b6257b3185be2984f1105f66c679611e7883f49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    }
  ]
}